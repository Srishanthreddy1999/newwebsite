<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QC Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-primary: #0f1419;
            --bg-secondary: #1a1f29;
            --bg-card: #242b38;
            --accent: #00e5ff;
            --accent-glow: rgba(0, 229, 255, 0.15);
            --text-primary: #ffffff;
            --text-secondary: #8b95a5;
            --border: #2d3648;
            --success: #00ff88;
            --warning: #ffb800;
            --error: #ff4757;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Manrope', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #000 100%);
            position: relative;
        }

        .login-container::before {
            content: '';
            position: absolute;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
            top: 20%;
            left: 10%;
            animation: float 8s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(30px, -30px); }
        }

        .login-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 50px 60px;
            width: 450px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            position: relative;
            z-index: 1;
        }

        .login-logo {
            font-size: 32px;
            font-weight: 800;
            text-align: center;
            margin-bottom: 40px;
            background: linear-gradient(135deg, var(--accent), #00b8d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -1px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input {
            width: 100%;
            padding: 14px 18px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: 'Manrope', sans-serif;
            font-size: 15px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .btn-login {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--accent), #00b8d4);
            border: none;
            border-radius: 10px;
            color: #000;
            font-family: 'Manrope', sans-serif;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px var(--accent-glow);
        }

        .error-message {
            display: none;
            padding: 12px;
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid var(--error);
            border-radius: 8px;
            color: var(--error);
            font-size: 13px;
            margin-top: 15px;
            text-align: center;
        }

        /* Main App */
        .app-container {
            display: none;
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent), #00b8d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .nav-tabs {
            display: flex;
            gap: 5px;
        }

        .nav-tab {
            padding: 10px 24px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-family: 'Manrope', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .nav-tab:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-tab.active {
            color: var(--accent);
            background: var(--accent-glow);
        }

        .logout-btn {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            border-radius: 8px;
            font-family: 'Manrope', sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            border-color: var(--error);
            color: var(--error);
        }

        .content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--accent);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .stat-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 800;
            font-family: 'DM Mono', monospace;
            color: var(--accent);
        }

        /* Data Table */
        .table-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 30px;
            overflow: hidden;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .table-title {
            font-size: 20px;
            font-weight: 700;
        }

        .table-actions {
            display: flex;
            gap: 12px;
        }

        .search-input {
            padding: 10px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Manrope', sans-serif;
            font-size: 14px;
            width: 250px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn-download {
            padding: 10px 20px;
            background: var(--success);
            border: none;
            border-radius: 8px;
            color: #000;
            font-family: 'Manrope', sans-serif;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-download:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 136, 0.3);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead th {
            text-align: left;
            padding: 16px;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }

        tbody td {
            padding: 18px 16px;
            border-bottom: 1px solid rgba(45, 54, 72, 0.5);
            font-size: 14px;
        }

        tbody tr {
            transition: all 0.2s;
        }

        tbody tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-group-a { background: rgba(255, 184, 0, 0.15); color: var(--warning); }
        .status-vibration { background: rgba(0, 229, 255, 0.15); color: var(--accent); }
        .status-thermal { background: rgba(138, 43, 226, 0.15); color: #a78bfa; }
        .status-anr { background: rgba(255, 107, 53, 0.15); color: #ff6b35; }
        .status-dispatched { background: rgba(0, 255, 136, 0.15); color: var(--success); }

        .btn-edit {
            padding: 6px 16px;
            background: transparent;
            border: 1px solid var(--accent);
            border-radius: 6px;
            color: var(--accent);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-edit:hover {
            background: var(--accent);
            color: #000;
        }

        .btn-delete {
            padding: 6px 16px;
            background: transparent;
            border: 1px solid var(--error);
            border-radius: 6px;
            color: var(--error);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-delete:hover {
            background: var(--error);
            color: #fff;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* Configuration Form */
        .config-form {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            max-width: 700px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-field {
            margin-bottom: 20px;
        }

        .form-field label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-field input,
        .form-field select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Manrope', sans-serif;
            font-size: 14px;
        }

        .form-field input:focus,
        .form-field select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .btn-submit {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--accent), #00b8d4);
            border: none;
            border-radius: 8px;
            color: #000;
            font-family: 'Manrope', sans-serif;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--accent-glow);
        }

        /* Templates */
        .template-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 24px;
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .template-title {
            font-size: 20px;
            font-weight: 700;
        }

        .btn-add {
            padding: 10px 20px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: #000;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--accent-glow);
        }

        .template-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .template-item {
            padding: 10px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .template-item button {
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            line-height: 1;
        }

        .template-item button:hover {
            color: #ff6b7a;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            width: 90%;
            max-width: 500px;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
        }

        .btn-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 28px;
            cursor: pointer;
            line-height: 1;
            transition: all 0.3s;
        }

        .btn-close:hover {
            color: var(--error);
            transform: rotate(90deg);
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-cancel {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-family: 'Manrope', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-cancel:hover {
            border-color: var(--error);
            color: var(--error);
        }

        .btn-save {
            flex: 1;
            padding: 12px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: #000;
            font-family: 'Manrope', sans-serif;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--accent-glow);
        }

        /* Success Message */
        .success-msg {
            display: none;
            padding: 14px;
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid var(--success);
            border-radius: 8px;
            color: var(--success);
            font-size: 14px;
            margin-top: 16px;
            text-align: center;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 20px;
            }

            .nav-tabs {
                width: 100%;
                justify-content: center;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .table-header {
                flex-direction: column;
                align-items: stretch;
            }

            .table-actions {
                flex-direction: column;
            }

            .search-input {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <div class="login-logo">QC TRACKER</div>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="loginUsername" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn-login">Sign In</button>
                <div class="error-message" id="loginError">Invalid username or password</div>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div class="app-container" id="mainApp">
        <header class="header">
            <div class="logo">QC TRACKER</div>
            <nav class="nav-tabs">
                <button class="nav-tab active" onclick="showPage('dashboard')">Dashboard</button>
                <button class="nav-tab" onclick="showPage('templates')">Templates</button>
                <button class="nav-tab" onclick="showPage('configuration')">Configuration</button>
            </nav>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </header>

        <div class="content">
            <!-- Dashboard Page -->
            <div id="dashboard" class="page active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Group A</div>
                        <div class="stat-value" id="stat-group-a">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Vibration</div>
                        <div class="stat-value" id="stat-vibration">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Thermal</div>
                        <div class="stat-value" id="stat-thermal">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ANR Testing</div>
                        <div class="stat-value" id="stat-anr">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Dispatched</div>
                        <div class="stat-value" id="stat-dispatched">0</div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <h2 class="table-title">QC Status</h2>
                        <div class="table-actions">
                            <input type="text" class="search-input" placeholder="Search..." onkeyup="filterTable()">
                            <button class="btn-download" onclick="downloadExcel()">Download Excel</button>
                        </div>
                    </div>
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th>Module Name</th>
                                <th>S.No</th>
                                <th>Client Name</th>
                                <th>Current Stage</th>
                                <th>Entry Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="6" class="empty-state">
                                    <div class="empty-state-icon">üìä</div>
                                    <div>No data yet. Add your first entry in Configuration.</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Templates Page -->
            <div id="templates" class="page">
                <div class="template-section">
                    <div class="template-header">
                        <h2 class="template-title">Module Templates</h2>
                        <button class="btn-add" onclick="openAddModuleModal()">+ Add Module</button>
                    </div>
                    <div class="template-list" id="moduleTemplateList">
                        <div style="color: var(--text-secondary); font-size: 14px;">No modules yet. Add your first module template.</div>
                    </div>
                </div>

                <div class="template-section">
                    <div class="template-header">
                        <h2 class="template-title">Client Templates</h2>
                        <button class="btn-add" onclick="openAddClientModal()">+ Add Client</button>
                    </div>
                    <div class="template-list" id="clientTemplateList">
                        <div style="color: var(--text-secondary); font-size: 14px;">No clients yet. Add your first client template.</div>
                    </div>
                </div>
            </div>

            <!-- Configuration Page -->
            <div id="configuration" class="page">
                <div class="config-form">
                    <h2 style="margin-bottom: 30px; font-size: 24px;">Add New Entry</h2>
                    <form id="configForm" onsubmit="handleNewEntry(event)">
                        <div class="form-row">
                            <div class="form-field">
                                <label>Module Name</label>
                                <select id="moduleName" required>
                                    <option value="">Select Module...</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label>S.No</label>
                                <input type="text" id="partNo" placeholder="e.g., 001" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-field">
                                <label>Client Name</label>
                                <select id="clientName" required>
                                    <option value="">Select Client...</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label>Current Stage</label>
                                <select id="stage" required>
                                    <option value="">Select Stage...</option>
                                    <option value="group-a">Group A</option>
                                    <option value="vibration">Vibration</option>
                                    <option value="thermal">Thermal</option>
                                    <option value="anr">ANR Testing</option>
                                    <option value="dispatched">Dispatched</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-field">
                            <label>Entry Date</label>
                            <input type="date" id="entryDate" required>
                        </div>
                        <button type="submit" class="btn-submit">Add Entry</button>
                        <div class="success-msg" id="configSuccess">Entry added successfully!</div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Module Modal -->
    <div class="modal" id="addModuleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Module Template</h3>
                <button class="btn-close" onclick="closeAddModuleModal()">&times;</button>
            </div>
            <div class="form-field">
                <label>Module Name</label>
                <input type="text" id="newModuleName" placeholder="e.g., Module-A-001">
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeAddModuleModal()">Cancel</button>
                <button class="btn-save" onclick="saveModule()">Save</button>
            </div>
        </div>
    </div>

    <!-- Add Client Modal -->
    <div class="modal" id="addClientModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Client Template</h3>
                <button class="btn-close" onclick="closeAddClientModal()">&times;</button>
            </div>
            <div class="form-field">
                <label>Client Name</label>
                <input type="text" id="newClientName" placeholder="e.g., TechCorp Industries">
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeAddClientModal()">Cancel</button>
                <button class="btn-save" onclick="saveClient()">Save</button>
            </div>
        </div>
    </div>

    <!-- Edit Entry Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Entry</h3>
                <button class="btn-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="form-field">
                <label>Module Name</label>
                <input type="text" id="editModuleName" readonly style="opacity: 0.6;">
            </div>
            <div class="form-field">
                <label>S.No</label>
                <input type="text" id="editPartNo" required>
            </div>
            <div class="form-field">
                <label>Client Name</label>
                <select id="editClientName" required>
                    <option value="">Select Client...</option>
                </select>
            </div>
            <div class="form-field">
                <label>Current Stage</label>
                <select id="editStage" required>
                    <option value="group-a">Group A</option>
                    <option value="vibration">Vibration</option>
                    <option value="thermal">Thermal</option>
                    <option value="anr">ANR Testing</option>
                    <option value="dispatched">Dispatched</option>
                </select>
            </div>
            <div class="form-field">
                <label>Entry Date</label>
                <input type="date" id="editEntryDate" required>
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeEditModal()">Cancel</button>
                <button class="btn-save" onclick="saveEdit()">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycby5sWfjOj_0PU9Fhnke6LFdBZmunGA3EeWPk4DKH4-zqnySF6XIap8E5k219NmYkB-N/exec';
        
        // Authentication
        const VALID_USERNAME = '123';
        const VALID_PASSWORD = '456';

        // Storage keys
        const STORAGE_MODULES = 'qc_modules';
        const STORAGE_CLIENTS = 'qc_clients';
        const STORAGE_AUTH = 'qc_authenticated';

        // Initialize
        window.onload = function() {
            checkAuth();
            loadTemplates();
        };

        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (username === VALID_USERNAME && password === VALID_PASSWORD) {
                localStorage.setItem(STORAGE_AUTH, 'true');
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                loadDataFromGoogleSheets();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function checkAuth() {
            if (localStorage.getItem(STORAGE_AUTH) === 'true') {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                loadDataFromGoogleSheets();
            }
        }

        function logout() {
            localStorage.removeItem(STORAGE_AUTH);
            location.reload();
        }

        // Page Navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(pageId).classList.add('active');
            event.target.classList.add('active');
            
            if (pageId === 'dashboard') {
                loadDataFromGoogleSheets();
            } else if (pageId === 'configuration') {
                populateDropdowns();
            }
        }

        // Template Management
        function loadTemplates() {
            const modules = JSON.parse(localStorage.getItem(STORAGE_MODULES) || '[]');
            const clients = JSON.parse(localStorage.getItem(STORAGE_CLIENTS) || '[]');
            
            // Display modules
            const moduleList = document.getElementById('moduleTemplateList');
            if (modules.length === 0) {
                moduleList.innerHTML = '<div style="color: var(--text-secondary); font-size: 14px;">No modules yet. Add your first module template.</div>';
            } else {
                moduleList.innerHTML = modules.map(m => `
                    <div class="template-item">
                        ${m}
                        <button onclick="deleteModule('${m}')">&times;</button>
                    </div>
                `).join('');
            }
            
            // Display clients
            const clientList = document.getElementById('clientTemplateList');
            if (clients.length === 0) {
                clientList.innerHTML = '<div style="color: var(--text-secondary); font-size: 14px;">No clients yet. Add your first client template.</div>';
            } else {
                clientList.innerHTML = clients.map(c => `
                    <div class="template-item">
                        ${c}
                        <button onclick="deleteClient('${c}')">&times;</button>
                    </div>
                `).join('');
            }
        }

        function populateDropdowns() {
            const modules = JSON.parse(localStorage.getItem(STORAGE_MODULES) || '[]');
            const clients = JSON.parse(localStorage.getItem(STORAGE_CLIENTS) || '[]');
            
            // Populate module dropdown
            const moduleSelect = document.getElementById('moduleName');
            moduleSelect.innerHTML = '<option value="">Select Module...</option>' + 
                modules.map(m => `<option value="${m}">${m}</option>`).join('');
            
            // Populate client dropdown
            const clientSelect = document.getElementById('clientName');
            clientSelect.innerHTML = '<option value="">Select Client...</option>' + 
                clients.map(c => `<option value="${c}">${c}</option>`).join('');
                
            // Populate edit client dropdown
            const editClientSelect = document.getElementById('editClientName');
            editClientSelect.innerHTML = '<option value="">Select Client...</option>' + 
                clients.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        // Module Modal
        function openAddModuleModal() {
            document.getElementById('addModuleModal').classList.add('active');
            document.getElementById('newModuleName').value = '';
        }

        function closeAddModuleModal() {
            document.getElementById('addModuleModal').classList.remove('active');
        }

        function saveModule() {
            const moduleName = document.getElementById('newModuleName').value.trim();
            if (!moduleName) {
                alert('Please enter a module name');
                return;
            }
            
            const modules = JSON.parse(localStorage.getItem(STORAGE_MODULES) || '[]');
            if (modules.includes(moduleName)) {
                alert('Module already exists');
                return;
            }
            
            modules.push(moduleName);
            localStorage.setItem(STORAGE_MODULES, JSON.stringify(modules));
            loadTemplates();
            populateDropdowns();
            closeAddModuleModal();
        }

        function deleteModule(moduleName) {
            if (!confirm(`Delete module "${moduleName}"?`)) return;
            
            let modules = JSON.parse(localStorage.getItem(STORAGE_MODULES) || '[]');
            modules = modules.filter(m => m !== moduleName);
            localStorage.setItem(STORAGE_MODULES, JSON.stringify(modules));
            loadTemplates();
            populateDropdowns();
        }

        // Client Modal
        function openAddClientModal() {
            document.getElementById('addClientModal').classList.add('active');
            document.getElementById('newClientName').value = '';
        }

        function closeAddClientModal() {
            document.getElementById('addClientModal').classList.remove('active');
        }

        function saveClient() {
            const clientName = document.getElementById('newClientName').value.trim();
            if (!clientName) {
                alert('Please enter a client name');
                return;
            }
            
            const clients = JSON.parse(localStorage.getItem(STORAGE_CLIENTS) || '[]');
            if (clients.includes(clientName)) {
                alert('Client already exists');
                return;
            }
            
            clients.push(clientName);
            localStorage.setItem(STORAGE_CLIENTS, JSON.stringify(clients));
            loadTemplates();
            populateDropdowns();
            closeAddClientModal();
        }

        function deleteClient(clientName) {
            if (!confirm(`Delete client "${clientName}"?`)) return;
            
            let clients = JSON.parse(localStorage.getItem(STORAGE_CLIENTS) || '[]');
            clients = clients.filter(c => c !== clientName);
            localStorage.setItem(STORAGE_CLIENTS, JSON.stringify(clients));
            loadTemplates();
            populateDropdowns();
        }

        // Load Data from Google Sheets
        function loadDataFromGoogleSheets() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-secondary);">Loading data from Google Sheets...</td></tr>';
            
            console.log('Fetching data from:', GOOGLE_SHEET_URL);
            
            fetch(GOOGLE_SHEET_URL)
                .then(response => {
                    console.log('Response received:', response);
                    return response.json();
                })
                .then(result => {
                    console.log('Data received:', result);
                    
                    if (result.status === 'success' && result.data && result.data.length > 0) {
                        tableBody.innerHTML = '';
                        
                        const stageClasses = {
                            'Group A': 'status-group-a',
                            'Vibration': 'status-vibration',
                            'Thermal': 'status-thermal',
                            'ANR Testing': 'status-anr',
                            'Dispatched': 'status-dispatched'
                        };
                        
                        result.data.forEach(item => {
                            const row = tableBody.insertRow();
                            let entryDate = item.entryDate;
                            if (entryDate instanceof Date || typeof entryDate === 'object') {
                                entryDate = new Date(entryDate).toISOString().split('T')[0];
                            }
                            
                            const stageClass = stageClasses[item.stage] || 'status-group-a';
                            
                            row.innerHTML = `
                                <td>${item.moduleName || ''}</td>
                                <td>${item.partNo || ''}</td>
                                <td>${item.clientName || ''}</td>
                                <td><span class="status-badge ${stageClass}">${item.stage || 'Unknown'}</span></td>
                                <td>${entryDate || ''}</td>
                                <td>
                                    <button class="btn-edit" onclick="editRow(this)">Edit</button>
                                    <button class="btn-delete" onclick="deleteRow(this)" style="margin-left: 8px;">Delete</button>
                                </td>
                            `;
                        });
                        
                        updateStats();
                        console.log('Data loaded successfully. Rows:', result.data.length);
                    } else {
                        console.log('No data found or empty response');
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="6" class="empty-state">
                                    <div class="empty-state-icon">üìä</div>
                                    <div>No data yet. Add your first entry in Configuration.</div>
                                </td>
                            </tr>
                        `;
                        updateStats();
                    }
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="empty-state">
                                <div class="empty-state-icon">‚ö†Ô∏è</div>
                                <div>Error loading data. Please check your Google Sheets connection.</div>
                                <div style="font-size: 12px; margin-top: 10px; color: var(--text-secondary);">Check browser console for details</div>
                            </td>
                        </tr>
                    `;
                });
        }

        // Update Statistics
        function updateStats() {
            const tableBody = document.getElementById('tableBody');
            const rows = tableBody.querySelectorAll('tr');
            
            const stats = {
                'group-a': 0,
                'vibration': 0,
                'thermal': 0,
                'anr': 0,
                'dispatched': 0
            };
            
            rows.forEach(row => {
                const statusBadge = row.querySelector('.status-badge');
                if (statusBadge) {
                    if (statusBadge.classList.contains('status-group-a')) stats['group-a']++;
                    if (statusBadge.classList.contains('status-vibration')) stats['vibration']++;
                    if (statusBadge.classList.contains('status-thermal')) stats['thermal']++;
                    if (statusBadge.classList.contains('status-anr')) stats['anr']++;
                    if (statusBadge.classList.contains('status-dispatched')) stats['dispatched']++;
                }
            });
            
            document.getElementById('stat-group-a').textContent = stats['group-a'];
            document.getElementById('stat-vibration').textContent = stats['vibration'];
            document.getElementById('stat-thermal').textContent = stats['thermal'];
            document.getElementById('stat-anr').textContent = stats['anr'];
            document.getElementById('stat-dispatched').textContent = stats['dispatched'];
        }

        // Handle New Entry
        function handleNewEntry(event) {
            event.preventDefault();
            
            const moduleName = document.getElementById('moduleName').value;
            const partNo = document.getElementById('partNo').value.trim();
            const clientName = document.getElementById('clientName').value;
            const stage = document.getElementById('stage').value;
            const entryDate = document.getElementById('entryDate').value;
            
            if (!moduleName || !partNo || !clientName || !stage || !entryDate) {
                alert('Please fill in all fields');
                return;
            }
            
            // Check for duplicate S.No within the SAME MODULE
            if (checkDuplicateSNo(moduleName, partNo, false)) {
                alert(`Duplicate S.No "${partNo}" found in module "${moduleName}"!\n\nEach module must have unique S.No values.\n\nPlease use a different S.No.`);
                return;
            }
            
            const stageNames = {
                'group-a': 'Group A',
                'vibration': 'Vibration',
                'thermal': 'Thermal',
                'anr': 'ANR Testing',
                'dispatched': 'Dispatched'
            };
            
            const formData = {
                moduleName: moduleName,
                partNo: partNo,
                clientName: clientName,
                stage: stageNames[stage],
                entryDate: entryDate
            };
            
            const successMsg = document.getElementById('configSuccess');
            successMsg.style.display = 'block';
            successMsg.textContent = 'Saving to Google Sheets...';
            successMsg.style.borderColor = 'var(--accent)';
            successMsg.style.color = 'var(--accent)';
            
            fetch(GOOGLE_SHEET_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            })
            .then(() => {
                successMsg.textContent = 'Entry added successfully! ‚úì';
                successMsg.style.borderColor = 'var(--success)';
                successMsg.style.color = 'var(--success)';
                
                document.getElementById('configForm').reset();
                
                setTimeout(() => {
                    loadDataFromGoogleSheets();
                }, 1000);
                
                setTimeout(() => {
                    successMsg.style.display = 'none';
                }, 3000);
            })
            .catch(error => {
                console.error('Error:', error);
                successMsg.textContent = 'Error saving to Google Sheets';
                successMsg.style.borderColor = 'var(--error)';
                successMsg.style.color = 'var(--error)';
            });
        }

        // Edit Functions
        let currentEditRow = null;
        let originalPartNo = null;
        let originalClientName = null;
        let originalModuleName = null;

        function editRow(button) {
            currentEditRow = button.closest('tr');
            const moduleName = currentEditRow.cells[0].textContent;
            const partNo = currentEditRow.cells[1].textContent;
            const clientName = currentEditRow.cells[2].textContent;
            const currentStage = currentEditRow.cells[3].querySelector('.status-badge').textContent;
            const entryDate = currentEditRow.cells[4].textContent;
            
            originalPartNo = partNo;
            originalClientName = clientName;
            originalModuleName = moduleName;
            
            document.getElementById('editModuleName').value = moduleName;
            document.getElementById('editPartNo').value = partNo;
            
            populateDropdowns();
            document.getElementById('editClientName').value = clientName;
            
            const stageValueMap = {
                'Group A': 'group-a',
                'Vibration': 'vibration',
                'Thermal': 'thermal',
                'ANR Testing': 'anr',
                'Dispatched': 'dispatched'
            };
            
            document.getElementById('editStage').value = stageValueMap[currentStage];
            document.getElementById('editEntryDate').value = entryDate;
            
            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            currentEditRow = null;
            originalPartNo = null;
            originalClientName = null;
            originalModuleName = null;
        }

        function checkDuplicateSNo(moduleName, sNo, excludeOriginal = false) {
            const tableBody = document.getElementById('tableBody');
            const rows = tableBody.querySelectorAll('tr');
            
            for (let row of rows) {
                if (row.cells.length < 2) continue;
                
                const rowModuleName = row.cells[0].textContent; // Module is column 0
                const rowSNo = row.cells[1].textContent; // S.No is column 1
                
                // If editing, skip the original row
                if (excludeOriginal && rowSNo === originalPartNo && rowModuleName === originalModuleName) {
                    continue;
                }
                
                // Check if SAME MODULE has same S.No
                if (rowModuleName === moduleName && rowSNo === sNo) {
                    return true; // Duplicate found in same module
                }
            }
            return false; // No duplicate - S.No is unique within this module
        }

        function saveEdit() {
            if (!currentEditRow) return;
            
            const moduleName = document.getElementById('editModuleName').value;
            const newPartNo = document.getElementById('editPartNo').value.trim();
            const newClientName = document.getElementById('editClientName').value;
            const newStage = document.getElementById('editStage').value;
            const newEntryDate = document.getElementById('editEntryDate').value;
            
            if (!newPartNo || !newClientName || !newStage || !newEntryDate) {
                alert('Please fill in all fields');
                return;
            }
            
            // Check for duplicate S.No within the SAME MODULE (excluding current entry)
            if (checkDuplicateSNo(moduleName, newPartNo, true)) {
                alert(`Duplicate S.No "${newPartNo}" found in module "${moduleName}"!\n\nEach module must have unique S.No values.`);
                return;
            }
            
            const stageClasses = {
                'group-a': 'status-group-a',
                'vibration': 'status-vibration',
                'thermal': 'status-thermal',
                'anr': 'status-anr',
                'dispatched': 'status-dispatched'
            };
            
            const stageNames = {
                'group-a': 'Group A',
                'vibration': 'Vibration',
                'thermal': 'Thermal',
                'anr': 'ANR Testing',
                'dispatched': 'Dispatched'
            };
            
            currentEditRow.cells[1].textContent = newPartNo;
            currentEditRow.cells[2].textContent = newClientName;
            currentEditRow.cells[3].innerHTML = `<span class="status-badge ${stageClasses[newStage]}">${stageNames[newStage]}</span>`;
            currentEditRow.cells[4].textContent = newEntryDate;
            
            const formData = {
                moduleName: moduleName,
                partNo: newPartNo,
                clientName: newClientName,
                stage: stageNames[newStage],
                entryDate: newEntryDate
            };
            
            fetch(GOOGLE_SHEET_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            })
            .then(() => {
                setTimeout(() => loadDataFromGoogleSheets(), 1000);
            })
            .catch(error => console.error('Error:', error));
            
            closeEditModal();
            updateStats();
            showNotification('Entry updated successfully!');
        }

        // Search/Filter
        function filterTable() {
            const input = event.target.value.toUpperCase();
            const table = document.getElementById('dataTable');
            const rows = table.getElementsByTagName('tr');
            
            for (let i = 1; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                let found = false;
                
                for (let j = 0; j < cells.length; j++) {
                    const cell = cells[j];
                    if (cell && cell.textContent.toUpperCase().indexOf(input) > -1) {
                        found = true;
                        break;
                    }
                }
                
                rows[i].style.display = found ? '' : 'none';
            }
        }

        // Delete Row
        function deleteRow(button) {
            if (!confirm('Are you sure you want to delete this entry?')) {
                return;
            }
            
            const row = button.closest('tr');
            const moduleName = row.cells[0].textContent;
            const partNo = row.cells[1].textContent;
            
            // Remove from table immediately
            row.remove();
            updateStats();
            
            // Note: Due to Google Sheets limitations with DELETE operations,
            // we mark it as deleted by adding it with a "DELETED" prefix
            // You can manually clean these from Google Sheets periodically
            // OR use the cleanOldEntries() function in Google Apps Script
            
            const formData = {
                moduleName: 'DELETED-' + moduleName,
                partNo: partNo,
                clientName: 'DELETED',
                stage: 'DELETED',
                entryDate: new Date().toISOString().split('T')[0]
            };
            
            fetch(GOOGLE_SHEET_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            })
            .then(() => {
                console.log('Delete marker added to Google Sheets');
                showNotification('Entry deleted successfully!');
            })
            .catch(error => console.error('Error:', error));
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--bg-card);
                border: 1px solid var(--accent);
                border-radius: 12px;
                padding: 16px 24px;
                color: var(--accent);
                font-weight: 600;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Download Excel
        function downloadExcel() {
            const table = document.getElementById('dataTable');
            const rows = table.querySelectorAll('tbody tr');
            
            const data = [];
            data.push(['Module Name', 'S.No', 'Client Name', 'Current Stage', 'Entry Date']);
            
            rows.forEach(row => {
                if (row.style.display !== 'none' && row.cells.length > 1) {
                    const cells = row.querySelectorAll('td');
                    const statusBadge = cells[3].querySelector('.status-badge');
                    data.push([
                        cells[0].textContent,
                        cells[1].textContent,
                        cells[2].textContent,
                        statusBadge ? statusBadge.textContent : '',
                        cells[4].textContent
                    ]);
                }
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            ws['!cols'] = [
                { wch: 20 },
                { wch: 12 },
                { wch: 25 },
                { wch: 18 },
                { wch: 15 }
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, "QC Data");
            
            const date = new Date();
            const filename = `QC_Tracker_${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}.xlsx`;
            
            XLSX.writeFile(wb, filename);
        }
    </script>
</body>
</html>